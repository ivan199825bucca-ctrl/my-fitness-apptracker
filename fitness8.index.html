<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Fitness Pro - Google Drive Sync</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen pb-24 font-sans text-sm">

    <header id="main-header" class="bg-indigo-700 text-white p-4 sticky top-0 z-50 shadow-md transition-colors duration-500">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold italic tracking-tighter uppercase">AI COACH PRO</h1>
                <input type="date" id="global-date" onchange="updateUI()" class="bg-white/20 text-white text-[10px] border-none rounded px-2 py-1 outline-none mt-1">
            </div>
            <div class="text-right">
                <p id="sync-status" class="text-[9px] uppercase opacity-60 mb-1">Offline</p>
                <p id="net-display" class="font-bold text-xl leading-none">0</p>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-4 space-y-6">

        <section class="bg-white rounded-2xl shadow-sm p-4 border border-indigo-100 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-100 p-2 rounded-lg text-indigo-600">
                    <i class="fab fa-google text-lg"></i>
                </div>
                <div>
                    <h3 class="font-bold text-xs uppercase">Cloud Sync</h3>
                    <p id="user-info" class="text-[10px] text-slate-500">I dati sono salvati solo localmente</p>
                </div>
            </div>
            <button id="auth-btn" onclick="handleAuthClick()" class="bg-indigo-600 text-white px-4 py-2 rounded-xl text-xs font-bold hover:bg-indigo-700 transition shadow-sm">
                Accedi con Google
            </button>
        </section>

        <section class="bg-white rounded-2xl shadow-sm p-5 border border-slate-200">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <div class="text-center border-r border-slate-100 last:border-0">
                    <p class="text-slate-400 text-[10px] uppercase">Peso</p>
                    <p class="font-bold text-base">71 kg</p>
                </div>
                <div class="text-center border-r border-slate-100 last:border-0">
                    <p class="text-slate-400 text-[10px] uppercase">TDEE Target</p>
                    <p class="font-bold text-base text-indigo-600">2747.6</p>
                </div>
                <div class="text-center border-r border-slate-100 last:border-0">
                    <p class="text-slate-400 text-[10px] uppercase">EtÃ </p>
                    <p class="font-bold text-base">27</p>
                </div>
                <div class="text-center last:border-0">
                    <p class="text-slate-400 text-[10px] uppercase">BMR</p>
                    <p class="font-bold text-base text-orange-600">1831.7</p>
                </div>
            </div>
        </section>

        <div class="grid md:grid-cols-2 gap-4">
            <section class="bg-white rounded-2xl shadow-sm p-5 border border-slate-200">
                <h2 class="text-lg font-bold text-green-600 mb-4"><i class="fas fa-utensils mr-2"></i>Cerca Cibo</h2>
                <div class="flex gap-2">
                    <input type="text" id="food-input" placeholder="OFF..." class="flex-1 p-3 bg-slate-50 rounded-xl outline-none border">
                    <button onclick="searchOFF()" class="bg-green-500 text-white px-4 rounded-xl"><i class="fas fa-search"></i></button>
                </div>
                <div id="food-results" class="mt-2 hidden max-h-40 overflow-auto"></div>
            </section>

            <section class="bg-white rounded-2xl shadow-sm p-5 border border-slate-200">
                <h2 class="text-lg font-bold text-red-600 mb-4"><i class="fas fa-dumbbell mr-2"></i>Cerca Esercizio</h2>
                <div class="flex gap-2">
                    <input type="text" id="exercise-input" placeholder="Wger..." class="flex-1 p-3 bg-slate-50 rounded-xl outline-none border">
                    <button onclick="searchWger()" class="bg-red-500 text-white px-4 rounded-xl"><i class="fas fa-search"></i></button>
                </div>
                <div id="exercise-results" class="mt-2 hidden max-h-40 overflow-auto"></div>
            </section>
        </div>

        <div id="workout-form" class="hidden bg-indigo-50 p-5 rounded-2xl border border-indigo-100">
            <p id="sel-ex-name" class="font-bold mb-3 uppercase text-indigo-700"></p>
            <div class="grid grid-cols-3 gap-2 mb-3">
                <input type="number" id="ex-sets" placeholder="Serie" class="p-2 rounded border">
                <input type="number" id="ex-reps" placeholder="Reps" class="p-2 rounded border">
                <input type="number" id="ex-weight" placeholder="Kg" class="p-2 rounded border font-bold">
            </div>
            <button onclick="confirmWorkout()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold">REGISTRA SESSIONE</button>
        </div>

        <section class="bg-white rounded-2xl shadow-sm p-5 border border-slate-200">
            <h2 class="text-xs font-bold mb-4 text-slate-400 uppercase tracking-widest italic">Diario del <span id="display-date"></span></h2>
            <div id="daily-log" class="space-y-3"></div>
        </section>

    </main>

    <script>
        // CONFIGURAZIONE GOOGLE
        const CLIENT_ID = '836723079936-2gldmnoklai4m24dusecotskv9kra13m.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyCPLarXCu7hXHam45n92xsau7h95GkVq7o';
        const DISCOVERY_DOC = "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest";
        const SCOPES = "https://www.googleapis.com/auth/drive.file";

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let user = { weight: 71, tdee: 2747.6 };
        let history = JSON.parse(localStorage.getItem('fitness_pro_v8')) || { diet: [], gym: [] };
        let fileId = null;

        // Inizializzazione Google API
        function gapiLoaded() { gapi.load('client', intializeGapiClient); }
        async function intializeGapiClient() {
            await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] });
            gapiInited = true;
        }
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: '' });
            gisInited = true;
        }

        async function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) throw (resp);
                document.getElementById('auth-btn').innerText = "Connesso";
                document.getElementById('sync-status').innerText = "Online (Cloud Sync)";
                await findOrCreateFile();
            };
            tokenClient.requestAccessToken({prompt: 'consent'});
        }

        async function findOrCreateFile() {
            const resp = await gapi.client.drive.files.list({ q: "name = 'fitness_pro_data.json'", fields: 'files(id, name)' });
            if (resp.result.files.length > 0) {
                fileId = resp.result.files[0].id;
                const fileData = await gapi.client.drive.files.get({ fileId: fileId, alt: 'media' });
                history = fileData.result;
                saveLocallyAndUI();
            } else {
                await uploadToDrive();
            }
        }

        async function uploadToDrive() {
            if (!fileId) {
                const metadata = { name: 'fitness_pro_data.json', mimeType: 'application/json' };
                const resp = await gapi.client.drive.files.create({ resource: metadata, fields: 'id' });
                fileId = resp.result.id;
            }
            const content = JSON.stringify(history);
            await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
                method: 'PATCH',
                headers: { 'Authorization': 'Bearer ' + gapi.client.getToken().access_token },
                body: content
            });
        }

        // LOGICA APP
        async function searchOFF() {
            const q = document.getElementById('food-input').value;
            const res = document.getElementById('food-results');
            if(q.length < 3) return;
            res.innerHTML = "Cercando..."; res.classList.remove('hidden');
            const response = await fetch(`https://it.openfoodfacts.org/cgi/search.pl?search_terms=${q}&json=1&page_size=5`);
            const data = await response.json();
            res.innerHTML = "";
            data.products.forEach(p => {
                const kcal = p.nutriments['energy-kcal_100g'] || 0;
                const div = document.createElement('div');
                div.className = "p-2 bg-slate-50 mb-1 rounded flex justify-between cursor-pointer hover:bg-green-50 text-[11px]";
                div.onclick = () => {
                    const g = prompt("Grammi?", "100");
                    if(g) {
                        history.diet.push({ date: new Date(document.getElementById('global-date').value).toLocaleDateString(), name: p.product_name, kcal: Math.round((kcal*g)/100), grams: g });
                        save();
                        res.classList.add('hidden');
                    }
                };
                div.innerHTML = `<span>${p.product_name}</span><b>${kcal}kcal</b>`;
                res.appendChild(div);
            });
        }

        async function searchWger() {
            const q = document.getElementById('exercise-input').value;
            const res = document.getElementById('exercise-results');
            if(q.length < 3) return;
            res.innerHTML = "Cercando..."; res.classList.remove('hidden');
            const response = await fetch(`https://wger.de/api/v2/exercise/search/?term=${q}`);
            const data = await response.json();
            res.innerHTML = "";
            data.suggestions.forEach(s => {
                const div = document.createElement('div');
                div.className = "p-2 bg-slate-50 mb-1 rounded text-[11px] cursor-pointer hover:bg-red-50";
                div.onclick = () => {
                    document.getElementById('sel-ex-name').innerText = s.value;
                    document.getElementById('workout-form').classList.remove('hidden');
                    res.classList.add('hidden');
                };
                div.innerText = s.value;
                res.appendChild(div);
            });
        }

        function confirmWorkout() {
            const name = document.getElementById('sel-ex-name').innerText;
            const kcalBurned = Math.round((6 * 3.5 * user.weight / 200) * 45); // Stima 45 min
            history.gym.push({
                date: new Date(document.getElementById('global-date').value).toLocaleDateString(),
                name, kcal: kcalBurned,
                sets: document.getElementById('ex-sets').value,
                reps: document.getElementById('ex-reps').value,
                weight: document.getElementById('ex-weight').value
            });
            save();
            document.getElementById('workout-form').classList.add('hidden');
        }

        function save() {
            localStorage.setItem('fitness_pro_v8', JSON.stringify(history));
            if (fileId) uploadToDrive();
            updateUI();
        }

        function saveLocallyAndUI() {
            localStorage.setItem('fitness_pro_v8', JSON.stringify(history));
            updateUI();
        }

        function updateUI() {
            const selDate = new Date(document.getElementById('global-date').value).toLocaleDateString();
            document.getElementById('display-date').innerText = selDate;
            const dayDiet = history.diet.filter(d => d.date === selDate);
            const dayGym = history.gym.filter(g => g.date === selDate);
            const totalIn = dayDiet.reduce((a,b)=>a+b.kcal, 0);
            const totalOut = dayGym.reduce((a,b)=>a+b.kcal, 0);
            const net = Math.round(user.tdee - totalIn + totalOut);
            document.getElementById('net-display').innerText = net;

            const logDiv = document.getElementById('daily-log');
            logDiv.innerHTML = "";
            dayDiet.forEach(d => {
                logDiv.innerHTML += `<div class="p-3 bg-white rounded-xl border-l-4 border-green-500 shadow-sm flex justify-between">
                    <div><b>${d.name}</b><br>${d.grams}g</div><b class="text-green-600">${d.kcal}kcal</b>
                </div>`;
            });
            dayGym.forEach(g => {
                logDiv.innerHTML += `<div class="p-3 bg-white rounded-xl border-l-4 border-red-500 shadow-sm flex justify-between">
                    <div><b>ðŸ’ª ${g.name}</b><br>${g.sets}x${g.reps} @ ${g.weight}kg</div><b class="text-red-600">-${g.kcal}kcal</b>
                </div>`;
            });
        }

        // Init scripts
        window.onload = () => {
            gapiLoaded();
            gisLoaded();
            document.getElementById('global-date').valueAsDate = new Date();
            updateUI();
        }
    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>