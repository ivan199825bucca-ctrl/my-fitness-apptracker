<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI COACH PRO - Dynamic TDEE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen pb-24 font-sans text-sm">

    <header class="bg-indigo-700 text-white p-4 sticky top-0 z-50 shadow-md">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold italic tracking-tighter uppercase">AI COACH PRO</h1>
                <input type="date" id="global-date" onchange="updateUI()" class="bg-white/20 text-white text-[10px] border-none rounded px-2 py-1 outline-none mt-1">
            </div>
            <div class="text-right">
                <p id="sync-status" class="text-[9px] uppercase opacity-60 mb-1">Cloud Offline</p>
                <div id="net-container" class="bg-white/10 px-3 py-1 rounded-lg">
                    <p id="net-display" class="font-bold text-xl leading-none">0</p>
                    <p class="text-[8px] uppercase font-medium">Calorie Residue</p>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-4 space-y-6">

        <section class="bg-white rounded-2xl shadow-sm p-5 border border-indigo-200">
            <h2 class="text-xs font-bold mb-4 text-indigo-600 uppercase tracking-widest"><i class="fas fa-sliders-h mr-2"></i>Setup Metabolico Manuale</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                <div>
                    <label class="text-[9px] uppercase font-bold text-slate-400">Peso (kg)</label>
                    <input type="number" id="user-weight" value="71.1" step="0.1" oninput="updateUI()" class="w-full p-2 bg-slate-50 border rounded-lg outline-none focus:border-indigo-400 font-bold">
                </div>
                <div>
                    <label class="text-[9px] uppercase font-bold text-slate-400">BMR (Fisso)</label>
                    <input type="number" id="user-bmr" value="1831.7" step="0.1" oninput="updateUI()" class="w-full p-2 bg-orange-50 text-orange-600 font-bold border rounded-lg outline-none">
                </div>
                <div>
                    <label class="text-[9px] uppercase font-bold text-slate-400">NEAT (Movimento)</label>
                    <input type="number" id="user-neat" value="915.9" step="0.1" oninput="updateUI()" class="w-full p-2 bg-indigo-50 text-indigo-600 font-bold border rounded-lg outline-none">
                </div>
                <div>
                    <label class="text-[9px] uppercase font-bold text-slate-400 italic">TEA (Allenamento)</label>
                    <div id="display-tea" class="w-full p-2 bg-red-50 text-red-600 font-bold rounded-lg border border-red-100">0</div>
                </div>
            </div>
            <div class="bg-slate-50 p-3 rounded-xl mb-4 text-center border border-slate-100">
                <p class="text-[10px] uppercase text-slate-500 font-bold">TDEE Dinamico Odierno (BMR + NEAT + TEA)</p>
                <p id="display-tdee-total" class="text-2xl font-black text-indigo-700">0</p>
            </div>
            <button onclick="saveUserParams()" class="w-full bg-indigo-600 text-white py-2 rounded-xl text-xs font-bold uppercase hover:bg-indigo-700 transition shadow-md">Salva Configurazione & Cloud</button>
        </section>

        <section class="bg-white rounded-2xl shadow-sm p-5 border border-slate-200">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-indigo-700 uppercase italic">Andamento</h2>
                <select id="chart-period" onchange="updateChart()" class="bg-slate-100 text-[10px] font-bold py-1 px-2 rounded-lg outline-none">
                    <option value="7">Settimanale</option>
                    <option value="30">Mensile</option>
                </select>
            </div>
            <div class="h-64 w-full">
                <canvas id="fitnessChart"></canvas>
            </div>
        </section>

        <div class="grid md:grid-cols-2 gap-4">
            <section class="bg-white rounded-2xl shadow-sm p-5 border border-slate-200">
                <h2 class="text-green-600 font-bold mb-3 uppercase text-center text-xs"><i class="fas fa-utensils mr-2"></i>Nutrizione</h2>
                <div class="flex gap-2">
                    <input type="text" id="food-input" placeholder="Cerca cibo..." class="flex-1 p-2 bg-slate-50 border rounded-xl outline-none text-xs">
                    <button onclick="searchOFF()" class="bg-green-500 text-white px-4 rounded-xl"><i class="fas fa-search"></i></button>
                </div>
                <div id="food-results" class="mt-2 hidden max-h-40 overflow-auto border rounded-lg"></div>
            </section>

            <section class="bg-white rounded-2xl shadow-sm p-5 border border-slate-200">
                <h2 class="text-red-600 font-bold mb-3 uppercase text-center text-xs"><i class="fas fa-dumbbell mr-2"></i>Allenamento (TEA)</h2>
                <div class="flex gap-2">
                    <input type="text" id="exercise-input" placeholder="Cerca esercizio..." class="flex-1 p-2 bg-slate-50 border rounded-xl outline-none text-xs">
                    <button onclick="searchWger()" class="bg-red-500 text-white px-4 rounded-xl"><i class="fas fa-search"></i></button>
                </div>
                <div id="exercise-results" class="mt-2 hidden max-h-40 overflow-auto border rounded-lg"></div>
            </section>
        </div>

        <section class="bg-white rounded-2xl shadow-sm p-5 border border-slate-200">
            <h2 class="text-xs font-bold text-blue-600 mb-4 uppercase text-center tracking-widest">Attività Cardio</h2>
            <div class="grid grid-cols-2 gap-3 mb-4">
                <button onclick="showCardioForm('walk')" class="bg-blue-50 text-blue-600 py-3 rounded-xl font-bold border border-blue-100 text-xs uppercase">Camminata</button>
                <button onclick="showCardioForm('bike')" class="bg-indigo-50 text-indigo-600 py-3 rounded-xl font-bold border border-indigo-100 text-xs uppercase">Cyclette</button>
            </div>
            <div id="cardio-form" class="hidden bg-slate-50 p-4 rounded-xl border border-slate-200">
                <div id="walk-inputs" class="hidden grid grid-cols-3 gap-2">
                    <input type="number" id="walk-kmh" placeholder="km/h" class="p-2 border rounded text-xs">
                    <input type="number" id="walk-min" placeholder="Min" class="p-2 border rounded text-xs">
                    <input type="number" id="walk-grade" placeholder="P.%" class="p-2 border rounded text-xs">
                </div>
                <div id="bike-inputs" class="hidden grid grid-cols-3 gap-2">
                    <input type="number" id="bike-level" placeholder="Liv." class="p-2 border rounded text-xs">
                    <input type="number" id="bike-min" placeholder="Min" class="p-2 border rounded text-xs">
                    <input type="number" id="bike-rpm" placeholder="RPM" class="p-2 border rounded text-xs">
                </div>
                <button onclick="confirmCardio()" class="w-full mt-3 bg-blue-600 text-white py-2 rounded-xl font-bold text-xs">REGISTRA ATTIVITÀ</button>
            </div>
        </section>

        <section class="bg-white rounded-2xl shadow-sm p-5 border border-slate-200">
            <h2 class="text-[10px] font-bold mb-4 text-slate-400 uppercase tracking-[0.2em] text-center">Log Attività: <span id="display-date"></span></h2>
            <div id="daily-log" class="space-y-3"></div>
        </section>

        <section class="bg-white rounded-2xl shadow-sm p-4 border border-indigo-100">
            <div id="auth-controls">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2">
                    <input type="email" id="supa-email" placeholder="Email Cloud" class="p-2 border rounded-xl text-xs outline-none">
                    <input type="password" id="supa-pass" placeholder="Password" class="p-2 border rounded-xl text-xs outline-none">
                </div>
                <div class="flex gap-2">
                    <button onclick="handleLogin()" class="flex-1 bg-indigo-600 text-white py-2 rounded-xl text-xs font-bold">ACCEDI</button>
                    <button onclick="handleSignup()" class="flex-1 bg-slate-200 text-slate-700 py-2 rounded-xl text-xs font-bold">REGISTRATI</button>
                </div>
            </div>
            <div id="logged-controls" class="hidden flex justify-between items-center">
                <p class="text-xs font-medium text-indigo-600"><i class="fas fa-user-circle mr-2"></i><span id="display-email"></span></p>
                <button onclick="handleLogout()" class="bg-red-100 text-red-600 px-3 py-1 rounded-lg text-[10px] font-bold uppercase">Esci</button>
            </div>
        </section>

    </main>

    <div id="workout-form" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center p-4 z-[100]">
        <div class="bg-white rounded-3xl p-6 w-full max-w-sm">
            <p id="sel-ex-name" class="font-bold mb-4 uppercase text-indigo-700 text-center border-b pb-2"></p>
            <div class="grid grid-cols-3 gap-3 mb-5">
                <div class="text-center"><label class="text-[10px] text-slate-400 uppercase">Serie</label><input type="number" id="ex-sets" class="w-full p-2 bg-slate-100 rounded-lg text-center"></div>
                <div class="text-center"><label class="text-[10px] text-slate-400 uppercase">Reps</label><input type="number" id="ex-reps" class="w-full p-2 bg-slate-100 rounded-lg text-center"></div>
                <div class="text-center"><label class="text-[10px] text-slate-400 uppercase">Kg</label><input type="number" id="ex-weight" class="w-full p-2 bg-slate-100 rounded-lg text-center font-bold"></div>
            </div>
            <button onclick="confirmWorkout()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold">SALVA ESERCIZIO</button>
            <button onclick="document.getElementById('workout-form').classList.add('hidden')" class="w-full mt-2 text-slate-400 text-xs font-bold uppercase">Annulla</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://wcvmxehvpyndedearscs.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indjdm14ZWh2cHluZGVkZWFyc2NzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3Njk5NDYsImV4cCI6MjA4NDM0NTk0Nn0.L2i2AB73GSWn-t0zWUk_o0XDfKLXXTtlIRUHFyxS21c';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let history = JSON.parse(localStorage.getItem('fitness_pro_v11')) || { diet: [], gym: [], cardio: [] };
        let myChart, activeCardioType = '';

        // --- LOGICA CALCOLO RICHIESTA ---
        // Calcolo: Residue = (BMR + NEAT) - CIBO + TEA
        function updateUI() {
            const sel = getSelectedDate();
            const weight = parseFloat(document.getElementById('user-weight').value) || 71.1;
            const bmr = parseFloat(document.getElementById('user-bmr').value) || 1831.7;
            const neat = parseFloat(document.getElementById('user-neat').value) || 915.9;

            document.getElementById('display-date').innerText = sel;
            
            // Filtro i dati del giorno
            const dDiet = history.diet.filter(d => d.date === sel);
            const dGym = (history.gym || []).filter(g => g.date === sel);
            const dCardio = (history.cardio || []).filter(c => c.date === sel);
            
            // Somma Calorie
            const kcalIn = dDiet.reduce((a,b) => a + b.kcal, 0);
            const tea = dGym.reduce((a,b) => a + b.kcal, 0) + dCardio.reduce((a,b) => a + b.kcal, 0);
            
            // Update TEA Display
            document.getElementById('display-tea').innerText = tea.toFixed(0);

            // Calcolo TDEE Dinamico
            const tdeeTotal = bmr + neat + tea;
            document.getElementById('display-tdee-total').innerText = tdeeTotal.toFixed(1);

            // CALCOLO RESIDUE: (BMR + NEAT) - CIBO + TEA
            // Nota: TEA è positivo perché sono calorie "guadagnate" per il budget
            const netResidue = Math.round((bmr + neat) - kcalIn + tea);
            
            const netDisplay = document.getElementById('net-display');
            const netContainer = document.getElementById('net-container');
            netDisplay.innerText = netResidue;

            // Feedback Visuale
            if (netResidue < 0) {
                netContainer.className = "bg-red-500 text-white px-3 py-1 rounded-lg transition-colors";
            } else {
                netContainer.className = "bg-green-500 text-white px-3 py-1 rounded-lg transition-colors";
            }

            // Render Log
            const logDiv = document.getElementById('daily-log');
            logDiv.innerHTML = "";
            dDiet.forEach(d => logDiv.innerHTML += logItem('diet', d.id, 'fa-utensils', 'text-green-500', d.name, `${d.grams}g`, `${d.kcal}kcal`));
            dGym.forEach(g => logDiv.innerHTML += logItem('gym', g.id, 'fa-dumbbell', 'text-red-500', g.name, `${g.sets}x${g.reps} @ ${g.weight}kg`, `+${g.kcal}kcal`));
            dCardio.forEach(c => logDiv.innerHTML += logItem('cardio', c.id, 'fa-heartbeat', 'text-blue-500', c.name, c.detail, `+${c.kcal}kcal`));
        }

        // Helper Parametri
        function getSelectedDate() { return new Date(document.getElementById('global-date').value).toLocaleDateString(); }

        function saveUserParams() {
            const params = {
                weight: parseFloat(document.getElementById('user-weight').value),
                bmr: parseFloat(document.getElementById('user-bmr').value),
                neat: parseFloat(document.getElementById('user-neat').value)
            };
            localStorage.setItem('user_params_v11', JSON.stringify(params));
            save();
            alert("Parametri salvati!");
        }

        function loadLocalParams() {
            const saved = JSON.parse(localStorage.getItem('user_params_v11'));
            if(saved) {
                document.getElementById('user-weight').value = saved.weight;
                document.getElementById('user-bmr').value = saved.bmr;
                document.getElementById('user-neat').value = saved.neat;
            }
        }

        // --- CORE FUNCTIONS (SAVE, DELETE, CHART) ---
        function save(cloud = true) {
            localStorage.setItem('fitness_pro_v11', JSON.stringify(history));
            if(cloud) syncToCloud();
            updateUI();
            updateChart();
        }

        function deleteItem(type, id) {
            if(confirm("Eliminare?")) {
                history[type] = history[type].filter(i => i.id !== id);
                save();
            }
        }

        function logItem(type, id, icon, color, title, sub, val) {
            return `<div class="p-4 bg-white rounded-2xl shadow-sm border border-slate-100 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <i class="fas ${icon} ${color} text-lg"></i>
                    <div><p class="font-bold text-[11px] uppercase">${title}</p><p class="text-[10px] text-slate-400">${sub}</p></div>
                </div>
                <div class="flex items-center gap-4">
                    <b class="text-xs ${val.startsWith('+') ? 'text-indigo-600' : 'text-green-600'}">${val}</b>
                    <button onclick="deleteItem('${type}', ${id})" class="text-slate-300 hover:text-red-500"><i class="fas fa-trash-alt"></i></button>
                </div>
            </div>`;
        }

        // --- API INTEGRATIONS (FOOD & GYM) ---
        async function searchOFF() {
            const q = document.getElementById('food-input').value;
            const res = document.getElementById('food-results');
            if(q.length < 3) return;
            res.innerHTML = "<p class='p-2 text-[10px] uppercase'>Ricerca...</p>"; res.classList.remove('hidden');
            const response = await fetch(`https://it.openfoodfacts.org/cgi/search.pl?search_terms=${q}&json=1&page_size=5`);
            const data = await response.json();
            res.innerHTML = "";
            data.products.forEach(p => {
                const kcal = p.nutriments['energy-kcal_100g'] || 0;
                const div = document.createElement('div');
                div.className = "p-2 border-b flex justify-between cursor-pointer hover:bg-slate-50 text-[11px]";
                div.onclick = () => {
                    const g = prompt("Grammi consumati?", "100");
                    if(g) {
                        history.diet.push({ id: Date.now(), date: getSelectedDate(), name: p.product_name, kcal: Math.round((kcal*g)/100), grams: g });
                        save();
                        res.classList.add('hidden');
                    }
                };
                div.innerHTML = `<span>${p.product_name}</span><b>${kcal} kcal</b>`;
                res.appendChild(div);
            });
        }

        async function searchWger() {
            const q = document.getElementById('exercise-input').value;
            const res = document.getElementById('exercise-results');
            if(q.length < 3) return;
            res.innerHTML = "<p class='p-2 text-[10px] uppercase'>Ricerca...</p>"; res.classList.remove('hidden');
            const response = await fetch(`https://wger.de/api/v2/exercise/search/?term=${q}`);
            const data = await response.json();
            res.innerHTML = "";
            data.suggestions.forEach(s => {
                const div = document.createElement('div');
                div.className = "p-2 border-b text-[11px] cursor-pointer hover:bg-slate-50";
                div.onclick = () => {
                    document.getElementById('sel-ex-name').innerText = s.value;
                    document.getElementById('workout-form').classList.remove('hidden');
                    res.classList.add('hidden');
                };
                div.innerText = s.value;
                res.appendChild(div);
            });
        }

        function confirmWorkout() {
            const weight = parseFloat(document.getElementById('user-weight').value);
            const name = document.getElementById('sel-ex-name').innerText;
            const sets = parseInt(document.getElementById('ex-sets').value) || 0;
            const kcalBurned = Math.round((6 * 3.5 * weight / 200) * (sets * 3.75));
            history.gym.push({ id: Date.now(), date: getSelectedDate(), name, kcal: kcalBurned, sets, reps: document.getElementById('ex-reps').value, weight: document.getElementById('ex-weight').value });
            save();
            document.getElementById('workout-form').classList.add('hidden');
        }

        // --- CARDIO LOGIC ---
        function showCardioForm(type) {
            activeCardioType = type;
            document.getElementById('cardio-form').classList.remove('hidden');
            document.getElementById('walk-inputs').classList.toggle('hidden', type !== 'walk');
            document.getElementById('bike-inputs').classList.toggle('hidden', type !== 'bike');
        }

        function confirmCardio() {
            const weight = parseFloat(document.getElementById('user-weight').value);
            let kcal = 0, detail = "", name = "";
            if(activeCardioType === 'walk') {
                const speed = parseFloat(document.getElementById('walk-kmh').value), min = parseFloat(document.getElementById('walk-min').value), grade = (parseFloat(document.getElementById('walk-grade').value)||0)/100;
                const vo2 = (0.1 * ((speed*1000)/60)) + (1.8 * ((speed*1000)/60) * grade) + 3.5;
                kcal = Math.round((vo2 * weight / 200) * min);
                name = "Camminata"; detail = `${speed}km/h, ${min}min, ${grade*100}% p.`;
            } else {
                const level = parseInt(document.getElementById('bike-level').value), min = parseInt(document.getElementById('bike-min').value), rpm = parseInt(document.getElementById('bike-rpm').value);
                let met = 5.0 + (level * 0.3) + (rpm / 30);
                kcal = Math.round((met * 3.5 * weight / 200) * min);
                name = "Cyclette"; detail = `Liv.${level}, ${min}min, ${rpm}RPM`;
            }
            history.cardio.push({ id: Date.now(), date: getSelectedDate(), name, kcal, detail });
            save();
            document.getElementById('cardio-form').classList.add('hidden');
        }

        // --- CLOUD SYNC ---
        async function syncToCloud() {
            const { data: { user } } = await _supabase.auth.getUser();
            if (!user) return;
            const { error } = await _supabase.from('profili utente').upsert({ 
                "ID utente": user.id, 
                macro_json: JSON.stringify(history), 
                peso: parseFloat(document.getElementById('user-weight').value),
                tdee: parseFloat(document.getElementById('user-bmr').value) // Usiamo bmr qui come riferimento
            });
            if (!error) document.getElementById('sync-status').innerText = "Cloud OK ✓";
        }

        async function handleLogin() {
            const email = document.getElementById('supa-email').value;
            const password = document.getElementById('supa-pass').value;
            await _supabase.auth.signInWithPassword({ email, password });
            location.reload();
        }

        async function handleLogout() {
            await _supabase.auth.signOut();
            location.reload();
        }

        // --- CHART ---
        function updateChart() {
            const days = parseInt(document.getElementById('chart-period').value);
            const bmr = parseFloat(document.getElementById('user-bmr').value);
            const neat = parseFloat(document.getElementById('user-neat').value);
            const ctx = document.getElementById('fitnessChart').getContext('2d');
            const labels = [], dataResidue = [];
            
            for(let i = days - 1; i >= 0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                const ds = d.toLocaleDateString();
                labels.push(ds.substring(0, 5));
                const kcalIn = history.diet.filter(x => x.date === ds).reduce((a,b)=>a+b.kcal, 0);
                const tea = (history.gym || []).filter(x => x.date === ds).reduce((a,b)=>a+b.kcal, 0) + (history.cardio || []).filter(x => x.date === ds).reduce((a,b)=>a+b.kcal, 0);
                dataResidue.push(Math.round((bmr + neat) - kcalIn + tea));
            }
            
            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets: [{ label: 'Residuo', data: dataResidue, borderColor: '#6366f1', tension: 0.4, fill: true, backgroundColor: 'rgba(99, 102, 241, 0.05)' }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        window.onload = async () => {
            document.getElementById('global-date').valueAsDate = new Date();
            loadLocalParams();
            const { data: { user } } = await _supabase.auth.getUser();
            if (user) {
                document.getElementById('auth-controls').classList.add('hidden');
                document.getElementById('logged-controls').classList.remove('hidden');
                document.getElementById('display-email').innerText = user.email;
                document.getElementById('sync-status').innerText = "Online";
                let { data } = await _supabase.from('profili utente').select('*').eq('ID utente', user.id).single();
                if (data && data.macro_json) {
                    history = JSON.parse(data.macro_json);
                }
            }
            updateUI();
            updateChart();
        };
    </script>
</body>
</html>
