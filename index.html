<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI COACH PRO - Integrated Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .circle-container { position: relative; width: 160px; height: 160px; }
        svg { transform: rotate(-90deg); }
        circle { fill: none; stroke-width: 10; stroke-linecap: round; }
        .bg-circle { stroke: #f1f5f9; }
        .progress-circle { 
            stroke: #10b981; 
            stroke-dasharray: 440; 
            stroke-dashoffset: 440; 
            transition: stroke-dashoffset 0.8s ease; 
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen pb-24 text-sm">

    <header class="bg-indigo-700 text-white p-4 sticky top-0 z-50 shadow-md">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold italic tracking-tighter uppercase">AI COACH PRO</h1>
                <input type="date" id="global-date" onchange="updateUI()" class="bg-white/20 text-white text-[10px] border-none rounded px-2 py-1 outline-none mt-1">
            </div>
            <div class="text-right">
                <p id="sync-status" class="text-[9px] uppercase opacity-60 mb-1">Cloud Offline</p>
                <div id="net-container" class="bg-white/10 px-3 py-1 rounded-lg">
                    <p id="net-display-header" class="font-bold text-xl leading-none">0</p>
                    <p class="text-[8px] uppercase font-medium">Kcal Residue</p>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-4 space-y-6">

        <section class="bg-white rounded-3xl shadow-xl p-6 border border-slate-100">
            <div class="flex flex-col md:flex-row justify-around items-center gap-6 mb-8">
                <div class="text-center">
                    <p id="kcal-eaten" class="text-3xl font-black leading-none text-slate-800">0</p>
                    <p class="text-slate-400 font-bold text-xs uppercase mt-2 tracking-wide">Mangiate</p>
                </div>

                <div class="circle-container flex items-center justify-center">
                    <svg width="160" height="160">
                        <circle class="bg-circle" cx="80" cy="80" r="70"></circle>
                        <circle id="ring-progress" class="progress-circle" cx="80" cy="80" r="70"></circle>
                    </svg>
                    <div class="absolute text-center">
                        <p id="net-display" class="text-4xl font-black leading-none text-slate-900">0</p>
                        <p class="text-slate-400 font-bold text-[10px] uppercase">Rimanenti</p>
                    </div>
                </div>

                <div class="text-center">
                    <p id="display-tea" class="text-3xl font-black leading-none text-indigo-600">0</p>
                    <p class="text-slate-400 font-bold text-xs uppercase mt-2 tracking-wide">Bruciate (TEA)</p>
                </div>
            </div>

            <div class="grid grid-cols-3 gap-4 border-t pt-6">
                <div class="space-y-2">
                    <p class="text-slate-500 font-bold text-center text-[10px] uppercase">Carboidrati</p>
                    <div class="h-1.5 w-full bg-slate-100 rounded-full overflow-hidden">
                        <div id="bar-carbs" class="h-full bg-emerald-500 transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <p class="text-[10px] font-black text-center"><span id="val-carbs">0</span> / <span id="target-carbs-display">207</span>g</p>
                </div>
                <div class="space-y-2">
                    <p class="text-slate-500 font-bold text-center text-[10px] uppercase">Proteine</p>
                    <div class="h-1.5 w-full bg-slate-100 rounded-full overflow-hidden">
                        <div id="bar-pro" class="h-full bg-emerald-500 transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <p class="text-[10px] font-black text-center"><span id="val-pro">0</span> / <span id="target-pro-display">115</span>g</p>
                </div>
                <div class="space-y-2">
                    <p class="text-slate-500 font-bold text-center text-[10px] uppercase">Grassi</p>
                    <div class="h-1.5 w-full bg-slate-100 rounded-full overflow-hidden">
                        <div id="bar-fat" class="h-full bg-emerald-500 transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <p class="text-[10px] font-black text-center"><span id="val-fat">0</span> / <span id="target-fat-display">61</span>g</p>
                </div>
            </div>
        </section>

        <section class="bg-white rounded-2xl shadow-sm p-5 border border-indigo-100">
            <h2 class="text-xs font-bold mb-4 text-indigo-600 uppercase tracking-widest text-center"><i class="fas fa-cog mr-2"></i>Impostazioni Target (Manuali)</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                <div>
                    <label class="text-[9px] uppercase font-bold text-slate-400">TDEE Fisso</label>
                    <input type="number" id="user-tdee" value="2747.6" step="0.1" oninput="updateUI()" class="w-full p-2 bg-indigo-50 text-indigo-700 font-bold border border-indigo-100 rounded-lg outline-none">
                </div>
                <div>
                    <label class="text-[9px] uppercase font-bold text-slate-400">Target C (g)</label>
                    <input type="number" id="target-carbs" value="207" oninput="updateUI()" class="w-full p-2 bg-slate-50 border rounded-lg outline-none">
                </div>
                <div>
                    <label class="text-[9px] uppercase font-bold text-slate-400">Target P (g)</label>
                    <input type="number" id="target-pro" value="115" oninput="updateUI()" class="w-full p-2 bg-slate-50 border rounded-lg outline-none">
                </div>
                <div>
                    <label class="text-[9px] uppercase font-bold text-slate-400">Target G (g)</label>
                    <input type="number" id="target-fat" value="61" oninput="updateUI()" class="w-full p-2 bg-slate-50 border rounded-lg outline-none">
                </div>
            </div>
            <button onclick="saveUserParams()" class="w-full bg-indigo-600 text-white py-2 rounded-xl text-xs font-bold uppercase hover:bg-indigo-700 transition shadow-md">Salva Parametri & Cloud</button>
        </section>

        <section class="bg-white rounded-2xl shadow-sm p-5 border border-slate-200">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-indigo-700 uppercase italic">Andamento</h2>
                <select id="chart-period" onchange="updateChart()" class="bg-slate-100 text-[10px] font-bold py-1 px-2 rounded-lg outline-none">
                    <option value="7">Settimanale</option>
                    <option value="30">Mensile</option>
                </select>
            </div>
            <div class="h-64 w-full">
                <canvas id="fitnessChart"></canvas>
            </div>
        </section>

        <div class="grid md:grid-cols-2 gap-4">
            <section class="bg-white rounded-2xl shadow-sm p-5 border border-slate-200">
                <h2 class="text-green-600 font-bold mb-3 uppercase text-center text-xs"><i class="fas fa-utensils mr-2"></i>Cibo</h2>
                <div class="flex gap-2">
                    <input type="text" id="food-input" placeholder="Cerca..." class="flex-1 p-2 bg-slate-50 border rounded-xl outline-none text-xs">
                    <button onclick="searchOFF()" class="bg-green-500 text-white px-4 rounded-xl"><i class="fas fa-search"></i></button>
                </div>
                <div id="food-results" class="mt-2 hidden max-h-40 overflow-auto border rounded-lg"></div>
            </section>

            <section class="bg-white rounded-2xl shadow-sm p-5 border border-slate-200">
                <h2 class="text-red-600 font-bold mb-3 uppercase text-center text-xs"><i class="fas fa-dumbbell mr-2"></i>Workout</h2>
                <div class="flex gap-2">
                    <input type="text" id="exercise-input" placeholder="Cerca..." class="flex-1 p-2 bg-slate-50 border rounded-xl outline-none text-xs">
                    <button onclick="searchWger()" class="bg-red-500 text-white px-4 rounded-xl"><i class="fas fa-search"></i></button>
                </div>
                <div id="exercise-results" class="mt-2 hidden max-h-40 overflow-auto border rounded-lg"></div>
            </section>
        </div>

        <section class="bg-white rounded-2xl shadow-sm p-5 border border-slate-200 text-center">
            <h2 class="text-xs font-bold text-blue-600 mb-4 uppercase tracking-widest text-center">Sessione Cardio</h2>
            <div class="grid grid-cols-2 gap-3 mb-4">
                <button onclick="showCardioForm('walk')" class="bg-blue-50 text-blue-600 py-3 rounded-xl font-bold border border-blue-100 text-xs uppercase">Camminata</button>
                <button onclick="showCardioForm('bike')" class="bg-indigo-50 text-indigo-600 py-3 rounded-xl font-bold border border-indigo-100 text-xs uppercase">Cyclette</button>
            </div>
            <div id="cardio-form" class="hidden bg-slate-50 p-4 rounded-xl border border-slate-200 text-left">
                <div id="walk-inputs" class="hidden grid grid-cols-3 gap-2">
                    <input type="number" id="walk-kmh" placeholder="km/h" class="p-2 border rounded text-xs">
                    <input type="number" id="walk-min" placeholder="Min" class="p-2 border rounded text-xs">
                    <input type="number" id="walk-grade" placeholder="P.%" class="p-2 border rounded text-xs">
                </div>
                <div id="bike-inputs" class="hidden grid grid-cols-3 gap-2">
                    <input type="number" id="bike-level" placeholder="Liv." class="p-2 border rounded text-xs">
                    <input type="number" id="bike-min" placeholder="Min" class="p-2 border rounded text-xs">
                    <input type="number" id="bike-rpm" placeholder="RPM" class="p-2 border rounded text-xs">
                </div>
                <button onclick="confirmCardio()" class="w-full mt-3 bg-blue-600 text-white py-2 rounded-xl font-bold text-xs uppercase">Registra Cardio</button>
            </div>
        </section>

        <section class="bg-white rounded-2xl shadow-sm p-5 border border-slate-200">
            <h2 class="text-[10px] font-bold mb-4 text-slate-400 uppercase tracking-[0.2em] text-center">Riepilogo: <span id="display-date"></span></h2>
            <div id="daily-log" class="space-y-3"></div>
        </section>

    </main>

    <div id="workout-form" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center p-4 z-[100]">
        <div class="bg-white rounded-3xl p-6 w-full max-w-sm">
            <p id="sel-ex-name" class="font-bold mb-4 uppercase text-indigo-700 text-center border-b pb-2"></p>
            <div class="grid grid-cols-3 gap-3 mb-5">
                <div class="text-center"><label class="text-[10px] text-slate-400 uppercase">Serie</label><input type="number" id="ex-sets" class="w-full p-2 bg-slate-100 rounded-lg text-center"></div>
                <div class="text-center"><label class="text-[10px] text-slate-400 uppercase">Reps</label><input type="number" id="ex-reps" class="w-full p-2 bg-slate-100 rounded-lg text-center"></div>
                <div class="text-center"><label class="text-[10px] text-slate-400 uppercase">Kg</label><input type="number" id="ex-weight" class="w-full p-2 bg-slate-100 rounded-lg text-center font-bold"></div>
            </div>
            <button onclick="confirmWorkout()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold">SALVA</button>
            <button onclick="document.getElementById('workout-form').classList.add('hidden')" class="w-full mt-2 text-slate-400 text-xs font-bold uppercase text-center">Annulla</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://wcvmxehvpyndedearscs.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indjdm14ZWh2cHluZGVkZWFyc2NzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3Njk5NDYsImV4cCI6MjA4NDM0NTk0Nn0.L2i2AB73GSWn-t0zWUk_o0XDfKLXXTtlIRUHFyxS21c';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let history = JSON.parse(localStorage.getItem('fitness_pro_v12')) || { diet: [], gym: [], cardio: [] };
        let myChart, activeCardioType = '';

        function updateUI() {
            const sel = getSelectedDate();
            const tdee = parseFloat(document.getElementById('user-tdee').value) || 2747.6;
            
            // Target Macro
            const tC = parseFloat(document.getElementById('target-carbs').value);
            const tP = parseFloat(document.getElementById('target-pro').value);
            const tG = parseFloat(document.getElementById('target-fat').value);
            
            document.getElementById('target-carbs-display').innerText = tC;
            document.getElementById('target-pro-display').innerText = tP;
            document.getElementById('target-fat-display').innerText = tG;

            document.getElementById('display-date').innerText = sel;
            
            const dDiet = history.diet.filter(d => d.date === sel);
            const dGym = (history.gym || []).filter(g => g.date === sel);
            const dCardio = (history.cardio || []).filter(c => c.date === sel);
            
            const kcalIn = dDiet.reduce((a,b) => a + b.kcal, 0);
            const carbsIn = dDiet.reduce((a,b) => a + (b.carbs || 0), 0);
            const proIn = dDiet.reduce((a,b) => a + (b.pro || 0), 0);
            const fatIn = dDiet.reduce((a,b) => a + (b.fat || 0), 0);
            
            const tea = dGym.reduce((a,b) => a + b.kcal, 0) + dCardio.reduce((a,b) => a + b.kcal, 0);
            
            // Visual Updates
            document.getElementById('kcal-eaten').innerText = Math.round(kcalIn).toLocaleString();
            document.getElementById('display-tea').innerText = Math.round(tea).toLocaleString();
            
            const netResidue = Math.round(tdee - kcalIn);
            document.getElementById('net-display').innerText = netResidue.toLocaleString();
            document.getElementById('net-display-header').innerText = netResidue;

            // Header Container Color
            const netContainer = document.getElementById('net-container');
            netContainer.className = netResidue < 0 ? "bg-red-500 text-white px-3 py-1 rounded-lg shadow-lg" : "bg-green-500 text-white px-3 py-1 rounded-lg shadow-lg";

            // Circle Progress
            const perc = Math.min(100, (kcalIn / tdee) * 100);
            document.getElementById('ring-progress').style.strokeDashoffset = 440 - (440 * perc / 100);
            document.getElementById('ring-progress').style.stroke = netResidue < 0 ? '#ef4444' : '#10b981';

            // Bars Progress
            updateBar('carbs', carbsIn, tC);
            updateBar('pro', proIn, tP);
            updateBar('fat', fatIn, tG);

            // Log
            const logDiv = document.getElementById('daily-log');
            logDiv.innerHTML = "";
            dDiet.forEach(d => logDiv.innerHTML += logItem('diet', d.id, 'fa-utensils', 'text-green-500', d.name, `${d.grams}g`, `${Math.round(d.kcal)}kcal`));
            dGym.forEach(g => logDiv.innerHTML += logItem('gym', g.id, 'fa-dumbbell', 'text-red-500', g.name, `${g.sets}x${g.reps} @ ${g.weight}kg`, `+${g.kcal} TEA`));
            dCardio.forEach(c => logDiv.innerHTML += logItem('cardio', c.id, 'fa-heartbeat', 'text-blue-500', c.name, c.detail, `+${c.kcal} TEA`));
        }

        function updateBar(id, current, target) {
            const p = Math.min(100, (current / target) * 100);
            document.getElementById(`bar-${id}`).style.width = p + '%';
            document.getElementById(`val-${id}`).innerText = Math.round(current);
        }

        function getSelectedDate() { return new Date(document.getElementById('global-date').value).toLocaleDateString(); }

        function saveUserParams() {
            const params = {
                tdee: parseFloat(document.getElementById('user-tdee').value),
                c: parseFloat(document.getElementById('target-carbs').value),
                p: parseFloat(document.getElementById('target-pro').value),
                g: parseFloat(document.getElementById('target-fat').value)
            };
            localStorage.setItem('user_params_v12', JSON.stringify(params));
            save();
            alert("Parametri salvati!");
        }

        function loadLocalParams() {
            const saved = JSON.parse(localStorage.getItem('user_params_v12'));
            if(saved) {
                document.getElementById('user-tdee').value = saved.tdee;
                document.getElementById('target-carbs').value = saved.c;
                document.getElementById('target-pro').value = saved.p;
                document.getElementById('target-fat').value = saved.g;
            }
        }

        function save(cloud = true) {
            localStorage.setItem('fitness_pro_v12', JSON.stringify(history));
            if(cloud) syncToCloud();
            updateUI();
            updateChart();
        }

        function deleteItem(type, id) {
            if(confirm("Eliminare?")) {
                history[type] = history[type].filter(i => i.id !== id);
                save();
            }
        }

        function logItem(type, id, icon, color, title, sub, val) {
            return `<div class="p-4 bg-white rounded-2xl shadow-sm border border-slate-100 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <i class="fas ${icon} ${color} text-lg"></i>
                    <div><p class="font-bold text-[11px] uppercase">${title}</p><p class="text-[10px] text-slate-400">${sub}</p></div>
                </div>
                <div class="flex items-center gap-4">
                    <b class="text-xs ${type === 'diet' ? 'text-slate-900' : 'text-indigo-600'}">${val}</b>
                    <button onclick="deleteItem('${type}', ${id})" class="text-slate-300 hover:text-red-500"><i class="fas fa-trash-alt"></i></button>
                </div>
            </div>`;
        }

        async function searchOFF() {
            const q = document.getElementById('food-input').value;
            const res = document.getElementById('food-results');
            if(q.length < 3) return;
            res.innerHTML = "<p class='p-2 text-[10px] uppercase animate-pulse'>Ricerca...</p>"; res.classList.remove('hidden');
            const response = await fetch(`https://it.openfoodfacts.org/cgi/search.pl?search_terms=${q}&json=1&page_size=5`);
            const data = await response.json();
            res.innerHTML = "";
            data.products.forEach(p => {
                const kcal = p.nutriments['energy-kcal_100g'] || 0;
                const c = p.nutriments.carbohydrates_100g || 0;
                const pr = p.nutriments.proteins_100g || 0;
                const f = p.nutriments.fat_100g || 0;
                const div = document.createElement('div');
                div.className = "p-2 border-b flex justify-between cursor-pointer hover:bg-slate-50 text-[11px]";
                div.onclick = () => {
                    const g = prompt(`Grammi di ${p.product_name}?`, "100");
                    if(g) {
                        const r = g/100;
                        history.diet.push({ id: Date.now(), date: getSelectedDate(), name: p.product_name, kcal: kcal*r, carbs: c*r, pro: pr*r, fat: f*r, grams: g });
                        save();
                        res.classList.add('hidden');
                    }
                };
                div.innerHTML = `<span>${p.product_name}</span><b>${kcal} kcal</b>`;
                res.appendChild(div);
            });
        }

        async function searchWger() {
            const q = document.getElementById('exercise-input').value;
            const res = document.getElementById('exercise-results');
            if(q.length < 3) return;
            res.innerHTML = "<p class='p-2 text-[10px] uppercase animate-pulse'>Ricerca...</p>"; res.classList.remove('hidden');
            const response = await fetch(`https://wger.de/api/v2/exercise/search/?term=${q}`);
            const data = await response.json();
            res.innerHTML = "";
            data.suggestions.forEach(s => {
                const div = document.createElement('div');
                div.className = "p-2 border-b text-[11px] cursor-pointer hover:bg-slate-50";
                div.onclick = () => {
                    document.getElementById('sel-ex-name').innerText = s.value;
                    document.getElementById('workout-form').classList.remove('hidden');
                    res.classList.add('hidden');
                };
                div.innerText = s.value;
                res.appendChild(div);
            });
        }

        function confirmWorkout() {
            const name = document.getElementById('sel-ex-name').innerText;
            const sets = parseInt(document.getElementById('ex-sets').value) || 0;
            const kcalBurned = Math.round((6 * 3.5 * 71 / 200) * (sets * 3.75));
            history.gym.push({ id: Date.now(), date: getSelectedDate(), name, kcal: kcalBurned, sets, reps: document.getElementById('ex-reps').value, weight: document.getElementById('ex-weight').value });
            save();
            document.getElementById('workout-form').classList.add('hidden');
        }

        function showCardioForm(type) {
            activeCardioType = type;
            document.getElementById('cardio-form').classList.remove('hidden');
            document.getElementById('walk-inputs').classList.toggle('hidden', type !== 'walk');
            document.getElementById('bike-inputs').classList.toggle('hidden', type !== 'bike');
        }

        function confirmCardio() {
            let kcal = 0, detail = "", name = "";
            if(activeCardioType === 'walk') {
                const speed = parseFloat(document.getElementById('walk-kmh').value), min = parseFloat(document.getElementById('walk-min').value), grade = (parseFloat(document.getElementById('walk-grade').value)||0)/100;
                const vo2 = (0.1 * ((speed*1000)/60)) + (1.8 * ((speed*1000)/60) * grade) + 3.5;
                kcal = Math.round((vo2 * 71 / 200) * min);
                name = "Camminata"; detail = `${speed}km/h, ${min}min`;
            } else {
                const level = parseInt(document.getElementById('bike-level').value), min = parseInt(document.getElementById('bike-min').value), rpm = parseInt(document.getElementById('bike-rpm').value);
                let met = 5.0 + (level * 0.3) + (rpm / 30);
                kcal = Math.round((met * 3.5 * 71 / 200) * min);
                name = "Cyclette"; detail = `Liv.${level}, ${min}min`;
            }
            history.cardio.push({ id: Date.now(), date: getSelectedDate(), name, kcal, detail });
            save();
            document.getElementById('cardio-form').classList.add('hidden');
        }

        async function syncToCloud() {
            const { data: { user } } = await _supabase.auth.getUser();
            if (!user) return;
            const tdee = parseFloat(document.getElementById('user-tdee').value);
            const { error } = await _supabase.from('profili utente').upsert({ 
                "ID utente": user.id, 
                macro_json: JSON.stringify(history), 
                tdee: tdee
            });
            if (!error) document.getElementById('sync-status').innerText = "Cloud OK âœ“";
        }

        function updateChart() {
            const days = parseInt(document.getElementById('chart-period').value);
            const tdee = parseFloat(document.getElementById('user-tdee').value);
            const ctx = document.getElementById('fitnessChart').getContext('2d');
            const labels = [], dataResidue = [];
            
            for(let i = days - 1; i >= 0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                const ds = d.toLocaleDateString();
                labels.push(ds.substring(0, 5));
                const kcalIn = history.diet.filter(x => x.date === ds).reduce((a,b)=>a+b.kcal, 0);
                dataResidue.push(Math.round(tdee - kcalIn));
            }
            
            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets: [{ label: 'Residuo', data: dataResidue, borderColor: '#6366f1', tension: 0.4, fill: true, backgroundColor: 'rgba(99, 102, 241, 0.05)' }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        window.onload = async () => {
            document.getElementById('global-date').valueAsDate = new Date();
            loadLocalParams();
            const { data: { user } } = await _supabase.auth.getUser();
            if (user) {
                document.getElementById('sync-status').innerText = "Online";
                let { data } = await _supabase.from('profili utente').select('*').eq('ID utente', user.id).single();
                if (data && data.macro_json) history = JSON.parse(data.macro_json);
            }
            updateUI();
            updateChart();
        };
    </script>
</body>
</html>
